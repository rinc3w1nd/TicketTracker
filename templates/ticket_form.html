{% extends "base.html" %}
{% if ticket %}
  {% set page_title = 'Edit Ticket' %}
{% else %}
  {% set page_title = 'New Ticket' %}
{% endif %}
{% set is_compact = compact_mode|default(true) %}
{% set compact_value = '1' if is_compact else '0' %}
{% if ticket %}
  {% set form_action = url_for('tickets.edit_ticket', ticket_id=ticket.id, compact=compact_value) %}
{% else %}
  {% set form_action = url_for('tickets.create_ticket', compact=compact_value) %}
{% endif %}
{% block title %}{{ page_title }} Â· TicketTracker{% endblock %}
{% block content %}
<section class="panel">
  <h2>{{ page_title }}</h2>
  <form method="post" action="{{ form_action }}" enctype="multipart/form-data" class="ticket-form">
    <div class="field-group">
      <label for="title">Title</label>
      <input type="text" id="title" name="title" value="{{ ticket.title if ticket else '' }}" required />
    </div>
    <div class="field-group">
      <label for="description">Description</label>
      <textarea id="description" name="description" rows="6" required>{{ ticket.description if ticket else '' }}</textarea>
    </div>
    <div class="field-group split">
      <div>
        <label for="requester">Requester</label>
        <input type="text" id="requester" name="requester" value="{{ ticket.requester if ticket else '' }}" />
      </div>
      <div>
        <label for="watchers">Watchers (comma separated)</label>
        <input type="text" id="watchers" name="watchers" value="{{ ticket.watchers|join(', ') if ticket else '' }}" />
      </div>
    </div>
    <div class="field-group split">
      <div>
        <label for="priority">Priority</label>
        <select id="priority" name="priority">
          {% for priority in priorities %}
            <option value="{{ priority }}" {% if ticket and ticket.priority == priority %}selected{% endif %}>{{ priority }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="status">Status</label>
        <select id="status" name="status">
          {% for status in workflow %}
            <option value="{{ status }}" {% if ticket and ticket.status == status %}selected{% endif %}>{{ status }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="field-group">
      <label for="due_date">Due date</label>
      <input type="datetime-local" id="due_date" name="due_date" value="{{ ticket.due_date.strftime('%Y-%m-%dT%H:%M') if ticket and ticket.due_date else '' }}" />
    </div>
    <div class="field-group" {% if not ticket or ticket.status != 'On Hold' %}data-hidden{% endif %}>
      <label for="on_hold_reason">On hold reason</label>
      <select id="on_hold_reason" name="on_hold_reason">
        <option value="">Select reason</option>
        {% for reason in hold_reasons %}
          <option value="{{ reason }}" {% if ticket and ticket.on_hold_reason == reason %}selected{% endif %}>{{ reason }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="field-group">
      <label for="tags">Tags</label>
      <input type="text" id="tags" name="tags" value="{{ ticket.tag_names|join(', ') if ticket else '' }}" placeholder="Comma separated" />
    </div>
    <div class="field-group">
      <label for="links">Links</label>
      <textarea id="links" name="links" rows="2" placeholder="One link per line">{{ ticket.links if ticket else '' }}</textarea>
    </div>
    <div class="field-group">
      <label for="notes">Private notes</label>
      <textarea id="notes" name="notes" rows="3">{{ ticket.notes if ticket else '' }}</textarea>
    </div>
    <details class="attachment-collapsible" data-attachment-collapsible>
      <summary class="attachment-toggle">
        <span class="attachment-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
            <path
              d="M16.5 6.5v8a4.5 4.5 0 1 1-9 0V5a3.5 3.5 0 0 1 7 0v9a2.5 2.5 0 1 1-5 0V6.5"
              fill="none"
              stroke="currentColor"
              stroke-width="1.7"
              stroke-linecap="round"
              stroke-linejoin="round"
            ></path>
          </svg>
        </span>
        <span class="attachment-toggle-text">
          <span class="attachment-toggle-state attachment-toggle-state--closed">Add attachments</span>
          <span class="attachment-toggle-state attachment-toggle-state--open">Hide attachments</span>
        </span>
        <span class="attachment-summary-count" data-attachment-count aria-live="polite" hidden></span>
      </summary>
      <div class="attachment-fields">
        <div class="field-group">
          <label for="attachments">Attachments</label>
          <input
            type="file"
            id="attachments"
            name="attachments"
            multiple
            aria-describedby="ticket-attachments-help"
            data-attachment-input
          />
          <p class="help" id="ticket-attachments-help">
            Selected files upload to <code>{{ app_config.uploads_path }}</code> when you save.
            Existing attachments stay unchanged, and you can choose multiple files at once.
          </p>
        </div>
      </div>
    </details>
    <div class="actions">
      <button type="submit" class="button primary">Save</button>
      <a class="button" href="{{ url_for('tickets.list_tickets', compact=compact_value) }}">Cancel</a>
    </div>
  </form>
</section>
<script>
  const statusSelect = document.getElementById('status');
  const holdGroup = document.querySelector('.ticket-form [data-hidden]');
  const toggleHold = () => {
    if (!holdGroup) return;
    if (statusSelect && statusSelect.value === 'On Hold') {
      holdGroup.removeAttribute('data-hidden');
    } else {
      holdGroup.setAttribute('data-hidden', '');
    }
  };
  if (statusSelect) {
    statusSelect.addEventListener('change', toggleHold);
    toggleHold();
  }

  const formatAttachmentCount = (count) => `${count} file${count === 1 ? '' : 's'} selected`;
  const attachmentDetails = document.querySelectorAll('[data-attachment-collapsible]');
  attachmentDetails.forEach((details) => {
    const input = details.querySelector('[data-attachment-input]');
    const count = details.querySelector('[data-attachment-count]');

    if (!input) return;

    const updateAttachmentState = () => {
      const files = input.files ? input.files.length : 0;
      if (files > 0) {
        details.dataset.hasFiles = 'true';
        if (count) {
          count.hidden = false;
          count.textContent = formatAttachmentCount(files);
        }
        if (!details.open) {
          details.open = true;
        }
      } else {
        delete details.dataset.hasFiles;
        if (count) {
          count.hidden = true;
          count.textContent = '';
        }
      }
    };

    input.addEventListener('change', updateAttachmentState);
    input.addEventListener('input', updateAttachmentState);
    updateAttachmentState();
  });
</script>
{% endblock %}
