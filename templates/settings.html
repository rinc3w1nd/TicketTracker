{% extends "base.html" %}
{% set is_compact = compact_mode|default(true) %}
{% set compact_value = '1' if is_compact else '0' %}
{% block title %}Settings Â· TicketTracker{% endblock %}
{% block content %}
  <section class="panel settings-panel">
    <form
      method="post"
      action="{{ url_for('settings.view_settings', compact=compact_value) }}"
      class="settings-form"
    >
      <div class="settings-header-row">
        <div class="settings-header-intro">
          <h2>Application settings</h2>
          <p class="help">
            {% if config.source_path %}
              Changes are saved to <code>{{ config.source_path }}</code>.
            {% else %}
              Changes are saved to the default configuration file.
            {% endif %}
          </p>
        </div>
        <div class="settings-header-control field-group">
          <label for="default_submitted_by">Default submitted by</label>
          <input
            type="text"
            id="default_submitted_by"
            name="default_submitted_by"
            value="{{ form.default_submitted_by|default('') }}"
            required
          />
        </div>
      </div>

      <div class="field-row field-row--thirds">
        <div class="field-group">
          <label for="priorities">Priorities</label>
          <textarea
            id="priorities"
            name="priorities"
            rows="4"
            required
          >{{- form.priorities|default('') -}}</textarea>
          <p class="help">Enter one priority per line, ordered from lowest to highest.</p>
        </div>

        <div class="field-group">
          <label for="hold_reasons">Hold reasons</label>
          <textarea
            id="hold_reasons"
            name="hold_reasons"
            rows="4"
            required
          >{{- form.hold_reasons|default('') -}}</textarea>
          <p class="help">Use one reason per line to populate the on-hold dropdown.</p>
        </div>

        <div class="field-group">
          <label for="workflow">Workflow statuses</label>
          <textarea
            id="workflow"
            name="workflow"
            rows="4"
            required
          >{{- form.workflow|default('') -}}</textarea>
          <p class="help">List statuses in the order they should appear in dropdowns.</p>
        </div>
      </div>

      <fieldset class="field-group sla-settings">
        <legend>Service level thresholds</legend>
        <p class="help">
          Configure when tickets change SLA stage or become overdue. Leave a field blank to
          fall back to defaults.
        </p>

        <div class="field-group field-group--inline">
          <div class="field-group__meta">
            <label for="default_due_days">Default backlog due days</label>
            <p class="help" id="default_due_days_help">
              Used when a priority does not specify custom backlog stage thresholds.
            </p>
          </div>
          <div class="field-group__control">
            <input
              type="number"
              id="default_due_days"
              name="default_due_days"
              min="0"
              value="{{ form.default_due_days|default('') }}"
              aria-describedby="default_due_days_help"
            />
          </div>
        </div>

        <div class="sla-stage-group">
          <h3>Due date stages</h3>
          <p class="help">
            Days remaining before a ticket advances through warning stages, listed from the
            lowest stage (Comfort Zone) through the highest stage (Fire Zone).
          </p>
          <div class="sla-stage-inputs">
            {% for label in sla_stage_labels %}
              {% set index = loop.index0 %}
              <label class="sla-stage-input" for="due_stage_days_{{ index }}">
                <span class="stage-label">{{ label }}</span>
                <input
                  type="number"
                  id="due_stage_days_{{ index }}"
                  name="due_stage_days"
                  min="0"
                  value="{{ form.due_stage_days[index]|default('') }}"
                />
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="sla-stage-group">
          <h3>Backlog stages by priority</h3>
          <p class="help">
            Provide the maximum age (in days) before backlog tickets escalate for each
            priority.
          </p>
          <table class="sla-priority-table">
            <thead>
              <tr>
                <th scope="col">Priority</th>
                {% for label in sla_stage_labels %}
                  <th scope="col">{{ label }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for priority, values in form.priority_stage_days.items() %}
                {% set priority_slug = priority|lower|replace(' ', '-')|replace('/', '-') %}
                <tr>
                  <th scope="row">{{ priority }}</th>
                  {% for label in sla_stage_labels %}
                    {% set stage_index = loop.index0 %}
                    <td>
                      <input
                        type="number"
                        name="priority_stage_days[{{ priority }}]"
                        id="priority_stage_days_{{ priority_slug }}_{{ stage_index }}"
                        min="0"
                        value="{{ values[stage_index]|default('') }}"
                        aria-label="{{ priority }} {{ label }}"
                      />
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <p class="help">Leave blanks to inherit the default backlog limit above.</p>
        </div>
      </fieldset>

      <fieldset class="field-group color-settings">
        <legend>Colors</legend>
        <p class="help">
          Customize the ticket palette. Leave a hex value blank to restore the default
          color.
        </p>
        <div class="color-palette">
          {% for section in color_sections %}
            <div class="color-section">
              <h3>{{ section.label }}</h3>
              <div class="color-section-grid">
                {% for entry in section.entries %}
                  {% set key_slug = entry.key|lower|replace(' ', '-')|replace('/', '-')|replace('[', '-')|replace(']', '-') %}
                  {% set input_id = "color_%s_%s" | format(section.name, key_slug) %}
                  <div class="color-entry">
                    <div class="color-entry-label">
                      <span class="color-chip" style="background-color: {{ entry.value }}" aria-hidden="true"></span>
                      <span>{{ entry.label }}</span>
                    </div>
                    <div class="color-entry-inputs">
                      <input
                        type="color"
                        id="{{ input_id }}"
                        name="{{ entry.field_name }}"
                        value="{{ entry.value }}"
                        aria-label="{{ entry.label }} color"
                      />
                      <input
                        type="text"
                        class="color-hex-input"
                        name="{{ entry.text_field_name }}"
                        value="{{ entry.text }}"
                        placeholder="{{ entry.default }}"
                        pattern="#?[0-9a-fA-F]{3}([0-9a-fA-F]{3})?"
                        title="Enter a hex color like #AABBCC or #ABC"
                        aria-label="{{ entry.label }} hex value"
                      />
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </fieldset>

      <fieldset class="field-group clipboard-sections">
        <legend>Clipboard sections</legend>
        <table class="clipboard-sections-table">
          <thead>
            <tr>
              <th scope="col">Section - Description</th>
              <th scope="col">HTML</th>
              <th scope="col">Text</th>
            </tr>
          </thead>
          <tbody>
            {% for section, description in clipboard_sections %}
              <tr>
                <th scope="row">
                  <span class="clipboard-section-label">
                    <code>{{ section }}</code> - {{ description }}
                  </span>
                </th>
                <td>
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      name="html_sections"
                      value="{{ section }}"
                      {% if section in form.selected_html_sections %}checked{% endif %}
                    />
                    <span class="sr-only">Include {{ section }} in HTML exports</span>
                  </label>
                </td>
                <td>
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      name="text_sections"
                      value="{{ section }}"
                      {% if section in form.selected_text_sections %}checked{% endif %}
                    />
                    <span class="sr-only">Include {{ section }} in text exports</span>
                  </label>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </fieldset>

      <div class="field-group field-group--inline">
        <div class="field-group__meta">
          <label for="updates_limit">Clipboard updates limit</label>
          <p class="help" id="updates_limit_help">
            Limit the number of recent updates included in clipboard exports.
          </p>
        </div>
        <div class="field-group__control">
          <input
            type="number"
            id="updates_limit"
            name="updates_limit"
            min="0"
            value="{{ form.updates_limit|default('') }}"
            aria-describedby="updates_limit_help"
          />
        </div>
      </div>

      <div class="field-group checkbox">
        <label class="checkbox-label" for="clipboard_debug_status">
          <input
            type="checkbox"
            id="clipboard_debug_status"
            name="clipboard_debug_status"
            {% if form.clipboard_debug_status %}checked{% endif %}
          />
          <span>Show clipboard copy debug details</span>
        </label>
        <p class="help">
          Include which clipboard strategy succeeded (HTML, text, or fallback) in copy status messages.
        </p>
      </div>

      <div class="field-group checkbox">
        <label class="checkbox-label" for="auto_return_to_list">
          <input
            type="checkbox"
            id="auto_return_to_list"
            name="auto_return_to_list"
            {% if form.auto_return_to_list %}checked{% endif %}
          />
          <span>Return to ticket list after saving</span>
        </label>
        <p class="help">
          Redirect back to the ticket list after editing tickets or posting updates.
        </p>
      </div>

      <div class="field-group checkbox">
        <label class="checkbox-label" for="demo_mode">
          <input
            type="checkbox"
            id="demo_mode"
            name="demo_mode"
            {% if form.demo_mode %}checked{% endif %}
          />
          <span>Enable demo mode enhancements</span>
        </label>
        <p class="help">Demo mode enables sample data helpers and other onboarding aids.</p>
      </div>

      <div class="actions">
        <button type="submit" class="button primary">Save changes</button>
        <a class="button" href="{{ url_for('tickets.list_tickets', compact=compact_value) }}">Cancel</a>
      </div>
    </form>
  </section>

  <section class="panel settings-panel">
    <h2>Demo mode controls</h2>
    <p class="help">
      Enable demo mode to explore TicketTracker with curated sample data. The current
      database and uploads are snapshotted and will be restored automatically when demo
      mode is disabled.
    </p>

    <dl class="status-list">
      <div class="status-item">
        <dt>Status</dt>
        <dd>
          {% if demo_status.active %}
            Active{% if demo_status.last_loaded_at %} (last loaded {{ demo_status.last_loaded_at }}){% endif %}
          {% else %}
            Disabled
          {% endif %}
        </dd>
      </div>
      <div class="status-item">
        <dt>Dataset</dt>
        <dd><code>{{ demo_status.dataset }}</code></dd>
      </div>
    </dl>

    <div class="actions demo-mode-actions">
      <form
        method="post"
        action="{{ url_for('settings.toggle_demo_mode', compact=compact_value) }}"
      >
        <input type="hidden" name="action" value="enable" />
        <button type="submit" class="button primary" {% if demo_status.active %}disabled{% endif %}>
          Enable demo mode
        </button>
      </form>

      <form
        method="post"
        action="{{ url_for('settings.toggle_demo_mode', compact=compact_value) }}"
      >
        <input type="hidden" name="action" value="disable" />
        <button type="submit" class="button" {% if not demo_status.active %}disabled{% endif %}>
          Disable demo mode
        </button>
      </form>

      <form
        method="post"
        action="{{ url_for('settings.toggle_demo_mode', compact=compact_value) }}"
      >
        <input type="hidden" name="action" value="refresh" />
        <button type="submit" class="button" {% if not demo_status.active %}disabled{% endif %}>
          Refresh demo data
        </button>
      </form>
    </div>
  </section>
{% endblock %}
