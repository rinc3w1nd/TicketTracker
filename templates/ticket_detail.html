{% extends "base.html" %}
{% block title %}{{ ticket.title }} · TicketTracker{% endblock %}
{% block content %}
{% set is_compact = compact_mode|default(true) %}
{% set compact_value = '1' if is_compact else '0' %}
<article
  class="ticket-detail ticket-surface{% if ticket.is_overdue %} is-overdue{% endif %}"
  data-clipboard-container
  data-clipboard-debug="{{ 'true' if config.clipboard_summary.debug_status else 'false' }}"
  data-overdue="{{ 'true' if ticket.is_overdue else 'false' }}"
  style="--ticket-accent: {{ ticket.display_color }}; --ticket-tint: {{ ticket.tint_color }}; --ticket-title-color: {{ ticket_title_color|default('#f8fafc') }};"
>
  <header>
    <div class="title-group">
      <h2 class="ticket-title">{{ ticket.title }}</h2>
      <div class="meta">
        <span class="status">
          <span
            class="status-badge"
            data-status="{{ (ticket.status or 'unknown')|lower|replace(' ', '-') }}"
            style="--status-color: {{ ticket.status_color }};"
          >
            {{ ticket.status }}
          </span>
          {% if ticket.status == 'On Hold' and ticket.on_hold_reason %}
            <span class="status-note">{{ ticket.on_hold_reason }}</span>
          {% endif %}
        </span>
        {% set priority_color = config.colors.priorities.get(ticket.priority, '#3b82f6') %}
        <span class="priority">
          <span
            class="priority-badge"
            data-priority="{{ ticket.priority }}"
            style="--priority-color: {{ priority_color }};"
          >
            {{ ticket.priority }}
          </span>
        </span>
        <span class="due" style="--due-color: {{ ticket.due_badge_color }};">
          <span
            class="due-badge"
            data-state="{{ ticket.due_badge_state }}"
          >
            {{ ticket.due_badge_label }}
          </span>
          {% if not ticket.due_date and ticket.age_reference_date %}
            <span class="age-badge">Aging since {{ ticket.age_reference_date.strftime('%b %d, %Y') }}</span>
          {% endif %}
        </span>
      </div>
    </div>
    <div class="ticket-card-actions">
      <div class="timestamps">
        <span>Created {{ ticket.created_at.strftime('%b %d, %Y %H:%M') }}</span>
        <span>Updated {{ ticket.updated_at.strftime('%b %d, %Y %H:%M') }}</span>
      </div>
      <div class="ticket-action-buttons">
        <div class="ticket-action-bar">
          <button
            type="button"
            class="icon-button clipboard-button"
            data-clipboard-button
            aria-describedby="clipboard-status-{{ ticket.id }}"
            title="Copy ticket summary"
          >
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                <path
                  d="M16 3H5a2 2 0 0 0-2 2v11h2V5h11V3zm3 4H9a2 2 0 0 0-2 2v12h12a2 2 0 0 0 2-2V7z"
                  fill="currentColor"
                ></path>
              </svg>
            </span>
            <span class="sr-only">Copy summary</span>
          </button>
          <button
            type="button"
            class="icon-button quick-attach-button"
            data-quick-attachment-trigger
            aria-controls="quick-attachment-input"
            title="Quick attach files"
          >
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                <path
                  d="M16.5 6.5v8a4.5 4.5 0 1 1-9 0V5a3.5 3.5 0 0 1 7 0v9a2.5 2.5 0 1 1-5 0V6.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.7"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ></path>
              </svg>
            </span>
            <span class="sr-only">Quick attach files</span>
          </button>
          <a
            class="icon-button edit-ticket-button"
            href="{{ url_for('tickets.edit_ticket', ticket_id=ticket.id, compact=compact_value) }}"
            title="Edit ticket"
          >
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                <path
                  d="M4 16.75V20h3.25L17.81 9.44l-3.25-3.25L4 16.75zm15.71-9.04a1.004 1.004 0 0 0 0-1.42l-2-2a1.004 1.004 0 0 0-1.42 0l-1.83 1.83 3.25 3.25 2-1.66z"
                  fill="currentColor"
                ></path>
              </svg>
            </span>
            <span class="sr-only">Edit ticket</span>
          </a>
        </div>
        <span
          class="clipboard-status"
          id="clipboard-status-{{ ticket.id }}"
          data-clipboard-status
          role="status"
          aria-live="polite"
        ></span>
      </div>
    </div>
  </header>

  <div class="clipboard-fallback" data-clipboard-fallback hidden>
    <p>Clipboard access isn't available. Select and copy the summary below.</p>
    <div class="clipboard-preview" data-clipboard-preview></div>
    <div class="clipboard-fallback-manual">
      <label
        class="clipboard-fallback-label"
        for="clipboard-fallback-text-{{ ticket.id }}"
      >
        Plain text summary
      </label>
      <textarea
        id="clipboard-fallback-text-{{ ticket.id }}"
        class="clipboard-fallback-text"
        data-clipboard-textarea
        readonly
      >{{- ticket.clipboard_summary.text | e -}}</textarea>
    </div>
  </div>
  <template data-clipboard-html>{{ ticket.clipboard_summary.html|safe }}</template>
  <template data-clipboard-text>{{- ticket.clipboard_summary.text -}}</template>

  <section class="detail-grid">
    <div>
      <h3>Description</h3>
      <p>{{ ticket.description|urlize|replace('\n', '<br />')|safe }}</p>
    </div>
    <aside>
      <dl>
        {% if ticket.requester %}
          <div>
            <dt>Requester</dt>
            <dd>{{ ticket.requester }}</dd>
          </div>
        {% endif %}
        {% if ticket.watchers %}
          <div>
            <dt>Watchers</dt>
            <dd>{{ ticket.watchers|join(', ') }}</dd>
          </div>
        {% endif %}
        {% if ticket.links %}
          <div>
            <dt>Links</dt>
            <dd>{{ ticket.links|urlize }}</dd>
          </div>
        {% endif %}
        {% if ticket.notes %}
          <div>
            <dt>Notes</dt>
            <dd>{{ ticket.notes|urlize|replace('\n', '<br />')|safe }}</dd>
          </div>
        {% endif %}
      </dl>
    </aside>
  </section>

  {% if ticket.tags %}
    <section class="tag-list">
      <h3>Tags</h3>
      <ul class="tags">
        {% for tag in ticket.tags %}
          <li style="--tag-color: {{ tag.color or config.colors.tags.background }}; --tag-text: {{ config.colors.tags.text }}">
            <a
              class="tag-link"
              href="{{ tag_filter_url(tag.name, compact_value) }}"
              title="Filter by tag {{ tag.name }}"
            >
              {{ tag.name }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

  {% if ticket.attachments %}
    <section class="attachments">
      <h3>Attachments</h3>
      <ul>
        {% for attachment in ticket.attachments %}
          <li>
            <a href="{{ url_for('tickets.download_attachment', attachment_id=attachment.id, compact=compact_value) }}">
              {{ attachment.display_name }}
            </a>
            <span class="attachment-meta">Uploaded {{ attachment.uploaded_at.strftime('%b %d, %Y %H:%M') }}</span>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

  <section class="updates">
    <h3>Updates</h3>
    <ol class="timeline">
      {% for update in ticket.updates|sort(attribute='created_at', reverse=true) %}
        <li>
          <div class="timeline-point"></div>
          <div class="timeline-content">
            <div class="update-meta">
              <span class="author">
                Attribute To:
                {{ 'System' if update.is_system else (update.author or config.default_submitted_by) }}
              </span>
              <span class="timestamp">{{ update.created_at.strftime('%b %d, %Y %H:%M') }}</span>
              {% if update.status_from or update.status_to %}
                <span class="status-change">{{ update.status_from or '—' }} → {{ update.status_to or '—' }}</span>
              {% endif %}
            </div>
            <p>{{ update.body|urlize|replace('\n', '<br />')|safe }}</p>
            {% if update.attachments %}
              <ul class="update-attachments">
                {% for attachment in update.attachments %}
                  <li>
                    <a href="{{ url_for('tickets.download_attachment', attachment_id=attachment.id, compact=compact_value) }}">
                      {{ attachment.display_name }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        </li>
      {% else %}
        <li class="empty">No updates yet.</li>
      {% endfor %}
    </ol>
  </section>
</article>

<section class="panel">
  <h3>Add update</h3>
  <form
    method="post"
    action="{{ url_for('tickets.add_update', ticket_id=ticket.id, compact=compact_value) }}"
    enctype="multipart/form-data"
    class="update-form"
  >
    <input
      type="hidden"
      name="auto_attachment"
      value="0"
      data-auto-attachment-flag
    />
    <input
      type="file"
      id="quick-attachment-input"
      name="attachments"
      multiple
      hidden
      data-quick-attachment-input
      aria-hidden="true"
      tabindex="-1"
    />
    <div class="field-group">
      <label for="message">Message</label>
      <textarea id="message" name="message" rows="4" placeholder="Share progress, blockers, or notes"></textarea>
    </div>
    <div class="form-controls-row">
      <div class="field-group">
        <label for="submitted_by">Attribute To</label>
        <input
          type="text"
          id="submitted_by"
          name="submitted_by"
          placeholder="Attribute To (defaults to {{ config.default_submitted_by }})"
          value="{{ config.default_submitted_by }}"
        />
      </div>
      <div class="field-group">
        <label for="status">Status</label>
        <select id="status" name="status">
          {% for status in config.workflow %}
            <option value="{{ status }}" {% if ticket.status == status %}selected{% endif %}>{{ status }}</option>
          {% endfor %}
        </select>
      </div>
      {% if not ticket.due_date %}
        <label class="form-checkbox" for="reage_ticket">
          <input type="checkbox" id="reage_ticket" name="reage_ticket" value="1" />
          Re-age ticket
        </label>
      {% endif %}
      <button type="submit" class="button primary">Add update</button>
    </div>
    <div
      class="field-group"
      data-on-hold-group
      {% if ticket.status != 'On Hold' %}data-hidden{% endif %}
    >
      <label for="on_hold_reason">On hold reason</label>
      <select id="on_hold_reason" name="on_hold_reason">
        <option value="">Select reason</option>
        {% for reason in hold_reasons %}
          <option value="{{ reason }}" {% if ticket.on_hold_reason == reason %}selected{% endif %}>{{ reason }}</option>
        {% endfor %}
      </select>
    </div>
  </form>
</section>
<script>
  const updateStatusSelect = document.getElementById('status');
  const updateHoldGroup = document.querySelector('[data-on-hold-group]');
  const updateToggleHold = () => {
    if (!updateHoldGroup) return;
    if (updateStatusSelect && updateStatusSelect.value === 'On Hold') {
      updateHoldGroup.removeAttribute('data-hidden');
    } else {
      updateHoldGroup.setAttribute('data-hidden', '');
    }
  };
  if (updateStatusSelect) {
    updateStatusSelect.addEventListener('change', updateToggleHold);
    updateToggleHold();
  }
</script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="module" src="{{ url_for('static', filename='js/clipboard.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/ticket_detail.js') }}"></script>
{% endblock %}
