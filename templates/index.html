{% extends "base.html" %}
{% block title %}Tickets Â· TicketTracker{% endblock %}
{% block content %}
{% set is_compact = compact_mode|default(true) %}
{% set compact_value = '1' if is_compact else '0' %}
<section class="panel">
  <form method="get" class="filter-form" data-filter-form>
    <input type="hidden" name="compact" value="{{ compact_value }}" />
    <div class="filter-toolbar">
      <div class="filter-controls">
        <span class="filter-label">Filter</span>
        <details
          class="filter-collapsible"
          data-filter-collapsible
          data-has-active="{{ 'true' if filters.has_active_filters else 'false' }}"
          {% if filters.has_active_filters %}open{% endif %}
        >
          <summary class="filter-toggle">
            <span class="filter-toggle-text">
              <span class="filter-toggle-state filter-toggle-state--closed">Click to Filterâ€¦</span>
              <span class="filter-toggle-state filter-toggle-state--open">Filter Options</span>
            </span>
            {% if filters.has_active_filters %}
              <span class="filter-indicator" aria-hidden="true">â€¢</span>
              <span class="sr-only">Active filters applied</span>
            {% endif %}
          </summary>
          <div class="filter-fields">
            <div class="field-group">
              <label for="search">Search</label>
              <input type="search" id="search" name="q" placeholder="Search tickets" value="{{ filters.search or '' }}" />
            </div>
            <div class="field-group">
              <label for="status">Status</label>
              <select id="status" name="status">
                <option value="">All</option>
                {% for status in config.workflow %}
                  <option value="{{ status }}" {% if filters.status == status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field-group">
              <label for="priority">Priority</label>
              <select id="priority" name="priority">
                <option value="">All</option>
                {% for priority in priorities %}
                  <option value="{{ priority }}" {% if filters.priority == priority %}selected{% endif %}>{{ priority }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field-group">
              <label for="tag">Tags</label>
              <select id="tag" name="tag" multiple size="3">
                {% for tag in available_tags %}
                  <option value="{{ tag.name }}" {% if tag.name in filters.tags %}selected{% endif %}>{{ tag.name }}</option>
                {% endfor %}
              </select>
              <div class="tag-mode">
                <label><input type="radio" name="tag_mode" value="any" {% if filters.tag_mode != 'all' %}checked{% endif %} /> Any</label>
                <label><input type="radio" name="tag_mode" value="all" {% if filters.tag_mode == 'all' %}checked{% endif %} /> All</label>
              </div>
            </div>
            <div class="actions filter-actions" role="group" aria-label="Filter actions">
              <button type="submit" class="button primary">Apply</button>
              <a
                href="{{ url_for('tickets.list_tickets', compact=compact_value) }}"
                class="button"
              >
                Reset
              </a>
            </div>
          </div>
        </details>
      </div>
      <div class="sort-controls" data-sort-controls>
        <span class="sort-label">Sort by</span>
        <div class="sort-button-group" role="group" aria-label="Sort tickets">
          {% set sort_order = filters.order %}
          {% set active_sort = filters.sort %}
          {% set defaults = {'due': 'asc', 'priority': 'asc', 'updated': 'desc', 'created': 'desc'} %}
          {% set buttons = [
            ('due', 'Due'),
            ('priority', 'Priority'),
            ('updated', 'Updated'),
            ('created', 'Created')
          ] %}
          {% for value, label in buttons %}
            {% set is_active = active_sort == value %}
            {% set button_order = sort_order if is_active else defaults[value] %}
            <button
              type="submit"
              name="sort"
              value="{{ value }}"
              class="sort-button{% if is_active %} is-active{% endif %}{% if is_active and sort_order == 'desc' %} is-desc{% endif %}"
              data-sort-button
              data-default-order="{{ defaults[value] }}"
              data-order="{{ button_order }}"
              aria-pressed="{{ 'true' if is_active else 'false' }}"
            >
              {{ label }}
            </button>
          {% endfor %}
        </div>
        <input type="hidden" name="order" value="{{ filters.order }}" data-sort-order />
      </div>
    </div>
  </form>
</section>

<section class="ticket-grid" style="--ticket-title-color: {{ ticket_title_color|default('#f8fafc') }};">
  {% if tickets %}
    {% for ticket in tickets %}
      <article
        class="ticket-card{% if ticket.is_overdue %} is-overdue{% endif %}"
        data-clipboard-container
        data-overdue="{{ 'true' if ticket.is_overdue else 'false' }}"
        style="--ticket-accent: {{ ticket.display_color }}; --ticket-tint: {{ ticket.tint_color }};"
        {% if is_compact and ticket.compact_tooltip %}
          title="{{ ticket.compact_tooltip }}"
          aria-label="{{ ticket.compact_tooltip }}"
        {% endif %}
      >
        <header>
          <div class="title-group">
            <h2 class="ticket-title">
              <a
                class="ticket-title-link"
                href="{{ url_for('tickets.ticket_detail', ticket_id=ticket.id, compact=compact_value) }}"
              >
                {{ ticket.title }}
              </a>
            </h2>
            <div class="meta">
              <span class="status">
                <span
                  class="status-badge"
                  data-status="{{ (ticket.status or 'unknown')|lower|replace(' ', '-') }}"
                  style="--status-color: {{ ticket.status_color }};"
                >
                  {{ ticket.status }}
                </span>
                {% if ticket.status == 'On Hold' and ticket.on_hold_reason %}
                  <span class="status-note">{{ ticket.on_hold_reason }}</span>
                {% endif %}
              </span>
              {% set priority_color = config.colors.priorities.get(ticket.priority, '#3b82f6') %}
              <span class="priority">
                <span
                  class="priority-badge"
                  data-priority="{{ ticket.priority }}"
                  style="--priority-color: {{ priority_color }};"
                >
                  {{ ticket.priority }}
                </span>
              </span>
              <span class="due" style="--due-color: {{ ticket.due_badge_color }};">
                <span
                  class="due-badge"
                  data-state="{{ ticket.due_badge_state }}"
                >
                  {{ ticket.due_badge_label }}
                </span>
                {% if not ticket.due_date and ticket.age_reference_date %}
                  <span class="age-badge">Aging since {{ ticket.age_reference_date.strftime('%b %d, %Y') }}</span>
                {% endif %}
              </span>
            </div>
          </div>
          <div class="ticket-card-actions">
            <div class="timestamps">
              <span title="Created">ðŸ•’ {{ ticket.created_at.strftime('%b %d, %Y') }}</span>
              <span title="Updated">ðŸ”„ {{ ticket.updated_at.strftime('%b %d, %Y %H:%M') }}</span>
            </div>
            <div class="clipboard-control">
              <button
                type="button"
                class="icon-button clipboard-button"
                data-clipboard-button
                aria-describedby="clipboard-status-{{ ticket.id }}"
                title="Copy ticket summary"
              >
                <span class="icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path
                      d="M16 3H5a2 2 0 0 0-2 2v11h2V5h11V3zm3 4H9a2 2 0 0 0-2 2v12h12a2 2 0 0 0 2-2V7z"
                      fill="currentColor"
                    ></path>
                  </svg>
                </span>
                <span class="sr-only">Copy summary</span>
              </button>
              <span
                class="clipboard-status"
                id="clipboard-status-{{ ticket.id }}"
                data-clipboard-status
                role="status"
                aria-live="polite"
              ></span>
            </div>
          </div>
        </header>
        <p class="description">{{ ticket.description|truncate(240) }}</p>
        {% if not is_compact and (ticket.requester or ticket.watchers or ticket.links) %}
          <dl class="ticket-details">
            {% if ticket.requester %}
              <div>
                <dt>Requester</dt>
                <dd>{{ ticket.requester }}</dd>
              </div>
            {% endif %}
            {% if ticket.watchers %}
              <div>
                <dt>Watchers</dt>
                <dd>{{ ticket.watchers|join(', ') }}</dd>
              </div>
            {% endif %}
            {% if ticket.links %}
              <div>
                <dt>Links</dt>
                <dd>{{ ticket.links }}</dd>
              </div>
            {% endif %}
          </dl>
        {% endif %}
        {% if ticket.tags %}
          <ul class="tags">
            {% for tag in ticket.tags %}
              <li style="--tag-color: {{ tag.color or config.colors.tags.background }}; --tag-text: {{ config.colors.tags.text }}">{{ tag.name }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <footer>
          <span>{{ ticket.updates|length }} updates</span>
          <span>{{ ticket.attachments|length }} attachments</span>
        </footer>
        <div class="clipboard-fallback" data-clipboard-fallback hidden>
          <p>Clipboard access isn't available. Select and copy the summary below.</p>
          <textarea
            class="clipboard-fallback-text"
            data-clipboard-textarea
            readonly
          >{{- ticket.clipboard_summary.text | e -}}</textarea>
        </div>
        <template data-clipboard-html>{{ ticket.clipboard_summary.html|safe }}</template>
        <template data-clipboard-text>{{- ticket.clipboard_summary.text -}}</template>
      </article>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <p>
        No tickets found.
        <a href="{{ url_for('tickets.create_ticket', compact=compact_value) }}">Create your first ticket.</a>
      </p>
    </div>
  {% endif %}
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filterDetails = document.querySelector('[data-filter-collapsible]');
    if (filterDetails) {
      const storageKey = 'tickettracker:filters:collapsed';
      const hasActive = filterDetails.getAttribute('data-has-active') === 'true';
      try {
        const storedState = window.localStorage.getItem(storageKey);
        if (storedState === 'open') {
          filterDetails.setAttribute('open', '');
        } else if (storedState === 'closed') {
          filterDetails.removeAttribute('open');
        } else if (hasActive) {
          filterDetails.setAttribute('open', '');
        }
      } catch (error) {
        if (hasActive) {
          filterDetails.setAttribute('open', '');
        }
      }

      filterDetails.addEventListener('toggle', function () {
        try {
          window.localStorage.setItem(
            storageKey,
            filterDetails.open ? 'open' : 'closed',
          );
        } catch (error) {
          /* ignore persistence errors */
        }
      });
    }

    const orderInput = document.querySelector('[data-sort-order]');
    const sortButtons = document.querySelectorAll('[data-sort-button]');
    sortButtons.forEach(function (button) {
      button.addEventListener('click', function () {
        if (!orderInput) {
          return;
        }

        const isActive = button.classList.contains('is-active');
        if (isActive) {
          const nextOrder = orderInput.value === 'asc' ? 'desc' : 'asc';
          orderInput.value = nextOrder;
          button.setAttribute('data-order', nextOrder);
          button.classList.toggle('is-desc', nextOrder === 'desc');
        } else {
          const defaultOrder = button.getAttribute('data-default-order');
          if (defaultOrder) {
            orderInput.value = defaultOrder;
            button.classList.toggle('is-desc', defaultOrder === 'desc');
            button.setAttribute('data-order', defaultOrder);
          }
        }
      });
    });
  });
</script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="module" src="{{ url_for('static', filename='js/clipboard.js') }}"></script>
{% endblock %}
