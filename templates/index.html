{% extends "base.html" %}
{% block title %}Tickets Â· TicketTracker{% endblock %}
{% block content %}
{% set is_compact = compact_mode|default(false) %}
<section class="panel">
  <form method="get" class="filter-form" data-filter-form>
    {% if is_compact %}
      <input type="hidden" name="compact" value="1" />
    {% endif %}
    <div class="filter-toolbar">
      <details
        class="filter-collapsible"
        data-filter-collapsible
        data-has-active="{{ 'true' if filters.has_active_filters else 'false' }}"
        {% if filters.has_active_filters %}open{% endif %}
      >
        <summary class="filter-toggle">
          <span>Filters</span>
          {% if filters.has_active_filters %}
            <span class="filter-indicator" aria-hidden="true">â€¢</span>
            <span class="sr-only">Active filters applied</span>
          {% endif %}
        </summary>
        <div class="filter-fields">
          <div class="field-group">
            <label for="search">Search</label>
            <input type="search" id="search" name="q" placeholder="Search tickets" value="{{ filters.search or '' }}" />
          </div>
          <div class="field-group">
            <label for="status">Status</label>
            <select id="status" name="status">
              <option value="">All</option>
              {% for status in config.workflow %}
                <option value="{{ status }}" {% if filters.status == status %}selected{% endif %}>{{ status }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field-group">
            <label for="priority">Priority</label>
            <select id="priority" name="priority">
              <option value="">All</option>
              {% for priority in priorities %}
                <option value="{{ priority }}" {% if filters.priority == priority %}selected{% endif %}>{{ priority }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field-group">
            <label for="tag">Tags</label>
            <select id="tag" name="tag" multiple size="3">
              {% for tag in available_tags %}
                <option value="{{ tag.name }}" {% if tag.name in filters.tags %}selected{% endif %}>{{ tag.name }}</option>
              {% endfor %}
            </select>
            <div class="tag-mode">
              <label><input type="radio" name="tag_mode" value="any" {% if filters.tag_mode != 'all' %}checked{% endif %} /> Any</label>
              <label><input type="radio" name="tag_mode" value="all" {% if filters.tag_mode == 'all' %}checked{% endif %} /> All</label>
            </div>
          </div>
        </div>
      </details>
      <div class="sort-controls" data-sort-controls>
        <span class="sort-label">Sort by</span>
        <div class="sort-button-group" role="group" aria-label="Sort tickets">
          {% set sort_order = filters.order %}
          {% set active_sort = filters.sort %}
          {% set defaults = {'due': 'asc', 'priority': 'asc', 'updated': 'desc', 'created': 'desc'} %}
          {% set buttons = [
            ('due', 'Due'),
            ('priority', 'Priority'),
            ('updated', 'Updated'),
            ('created', 'Created')
          ] %}
          {% for value, label in buttons %}
            {% set is_active = active_sort == value %}
            {% set button_order = sort_order if is_active else defaults[value] %}
            <button
              type="submit"
              name="sort"
              value="{{ value }}"
              class="sort-button{% if is_active %} is-active{% endif %}{% if is_active and sort_order == 'desc' %} is-desc{% endif %}"
              data-sort-button
              data-default-order="{{ defaults[value] }}"
              data-order="{{ button_order }}"
              aria-pressed="{{ 'true' if is_active else 'false' }}"
            >
              {{ label }}
            </button>
          {% endfor %}
        </div>
        <input type="hidden" name="order" value="{{ filters.order }}" data-sort-order />
      </div>
    </div>
    <div class="actions">
      <button type="submit" class="button primary">Apply</button>
      <a href="{{ url_for('tickets.list_tickets') }}{% if is_compact %}?compact=1{% endif %}" class="button">Reset</a>
    </div>
  </form>
</section>

<section class="ticket-grid">
  {% if tickets %}
    {% for ticket in tickets %}
      <article
        class="ticket-card{% if ticket.is_overdue %} is-overdue{% endif %}"
        data-overdue="{{ 'true' if ticket.is_overdue else 'false' }}"
        style="--ticket-accent: {{ ticket.display_color }}; --ticket-tint: {{ ticket.tint_color }};"
      >
        <header>
          <div class="title-group">
            <h2>
              <a href="{{ url_for('tickets.ticket_detail', ticket_id=ticket.id) }}{% if is_compact %}?compact=1{% endif %}">
                {{ ticket.title }}
              </a>
            </h2>
            <div class="meta">
              <span class="status">{{ ticket.status }}{% if ticket.status == 'On Hold' and ticket.on_hold_reason %} Â· {{ ticket.on_hold_reason }}{% endif %}</span>
              {% set priority_color = config.colors.priorities.get(ticket.priority, '#3b82f6') %}
              <span class="priority">
                <span
                  class="priority-badge"
                  data-priority="{{ ticket.priority }}"
                  style="--priority-color: {{ priority_color }};"
                >
                  {{ ticket.priority }}
                </span>
              </span>
              {% if ticket.due_date %}
                <span class="due">Due {{ ticket.due_date.strftime('%b %d, %Y %H:%M') }}</span>
              {% elif ticket.sla_countdown %}
                <span
                  class="due sla-chip"
                  data-sla-breached="{{ 'true' if ticket.sla_is_breached else 'false' }}"
                >
                  {{ ticket.sla_countdown }}
                </span>
              {% else %}
                <span class="due no-date">No due date</span>
              {% endif %}
            </div>
          </div>
          <div class="timestamps">
            <span title="Created">ðŸ•’ {{ ticket.created_at.strftime('%b %d, %Y') }}</span>
            <span title="Updated">ðŸ”„ {{ ticket.updated_at.strftime('%b %d, %Y %H:%M') }}</span>
          </div>
        </header>
        <p class="description">{{ ticket.description|truncate(240) }}</p>
        <dl class="ticket-details">
          {% if ticket.requester %}
            <div>
              <dt>Requester</dt>
              <dd>{{ ticket.requester }}</dd>
            </div>
          {% endif %}
          {% if ticket.watchers %}
            <div>
              <dt>Watchers</dt>
              <dd>{{ ticket.watchers|join(', ') }}</dd>
            </div>
          {% endif %}
          {% if ticket.links %}
            <div>
              <dt>Links</dt>
              <dd>{{ ticket.links }}</dd>
            </div>
          {% endif %}
        </dl>
        {% if ticket.tags %}
          <ul class="tags">
            {% for tag in ticket.tags %}
              <li style="--tag-color: {{ tag.color or config.colors.tags.background }}; --tag-text: {{ config.colors.tags.text }}">{{ tag.name }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        <footer>
          <span>{{ ticket.updates|length }} updates</span>
          <span>{{ ticket.attachments|length }} attachments</span>
        </footer>
      </article>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <p>
        No tickets found.
        <a href="{{ url_for('tickets.create_ticket') }}{% if is_compact %}?compact=1{% endif %}">Create your first ticket.</a>
      </p>
    </div>
  {% endif %}
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filterDetails = document.querySelector('[data-filter-collapsible]');
    if (filterDetails) {
      const storageKey = 'tickettracker:filters:collapsed';
      const hasActive = filterDetails.getAttribute('data-has-active') === 'true';
      try {
        const storedState = window.localStorage.getItem(storageKey);
        if (storedState === 'open') {
          filterDetails.setAttribute('open', '');
        } else if (storedState === 'closed') {
          filterDetails.removeAttribute('open');
        } else if (hasActive) {
          filterDetails.setAttribute('open', '');
        }
      } catch (error) {
        if (hasActive) {
          filterDetails.setAttribute('open', '');
        }
      }

      filterDetails.addEventListener('toggle', function () {
        try {
          window.localStorage.setItem(
            storageKey,
            filterDetails.open ? 'open' : 'closed',
          );
        } catch (error) {
          /* ignore persistence errors */
        }
      });
    }

    const orderInput = document.querySelector('[data-sort-order]');
    const sortButtons = document.querySelectorAll('[data-sort-button]');
    sortButtons.forEach(function (button) {
      button.addEventListener('click', function () {
        if (!orderInput) {
          return;
        }

        const isActive = button.classList.contains('is-active');
        if (isActive) {
          const nextOrder = orderInput.value === 'asc' ? 'desc' : 'asc';
          orderInput.value = nextOrder;
          button.setAttribute('data-order', nextOrder);
          button.classList.toggle('is-desc', nextOrder === 'desc');
        } else {
          const defaultOrder = button.getAttribute('data-default-order');
          if (defaultOrder) {
            orderInput.value = defaultOrder;
            button.classList.toggle('is-desc', defaultOrder === 'desc');
            button.setAttribute('data-order', defaultOrder);
          }
        }
      });
    });
  });
</script>
{% endblock %}
